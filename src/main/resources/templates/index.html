<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Monitor PLC</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background-color: #1e1e1e; 
            color: #d4d4d4;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; /* Solo para el body principal */
        }
        
        .ide-container {
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden; /* Contiene los paneles principales */
        }
        
        /* Panel de variables (izquierda) */
        .variables-panel {
            width: 300px;
            background-color: #252526;
            border-right: 1px solid #404040;
            padding: 10px 0;
            flex-shrink: 0;
            overflow-y: auto; /* Añadir barra de desplazamiento vertical */
            max-height: 100vh; /* Asegurar que no crece más allá de la ventana */
        }
        
        .panel-header {
            padding: 10px 15px;
            font-size: 14px;
            font-weight: bold;
            color: #cccccc;
            border-bottom: 1px solid #404040;
            background-color: #333333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .variable-item {
            padding: 8px 15px;
            border-bottom: 1px solid #383838;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .variable-item:hover {
            background-color: #2a2d2e;
        }
        
        .variable-name {
            font-size: 13px;
            color: #9cdcfe;
        }
        
        .variable-value {
            font-size: 13px;
            font-weight: bold;
            color: #ce9178;
            font-family: 'Consolas', monospace;
        }
        
        /* Panel principal (derecha) */
        .main-panel {
            flex-grow: 1;
            padding: 15px;
            background-color: #1e1e1e;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Contiene el área principal */
        }
        
        .toolbar {
            padding: 10px;
            background-color: #333333;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
            background-color: #555;
        }
        
        .status-active {
            background-color: #3ca45c;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        .fps-counter {
            font-size: 12px;
            color: #888;
            margin-left: 15px;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 15px;
            flex-grow: 1;
            grid-auto-rows: min-content;
        }
        
        .chart-card {
            background-color: #252526;
            border: 1px solid #404040;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .chart-header {
            padding: 10px;
            font-size: 13px;
            background-color: #333333;
            border-bottom: 1px solid #404040;
            color: #cccccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-control-btn {
            background-color: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .chart-control-btn:hover {
            background-color: #444444;
        }
        
        .control-icon {
            font-size: 14px;
        }
        
        .chart-body {
            padding: 10px;
            height: 300px; /* Aumentado de 200px a 300px */
        }
        
        .settings-panel {
            margin-top: 15px;
            background-color: #252526;
            border: 1px solid #404040;
            border-radius: 4px;
            padding: 15px;
        }
        
        /* Estilo para controles */
        input[type="number"] {
            background-color: #3c3c3c;
            border: 1px solid #555;
            color: #cccccc;
            padding: 5px 10px;
            border-radius: 3px;
        }
        
        button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #1177bb;
        }
        
        /* Variable tipos */
        .type-int { color: #569cd6; }
        .type-float { color: #b5cea8; }
        .type-bool { color: #4fc1ff; }

        /* Nuevos estilos para las gráficas ocultas */
        .chart-card.hidden {
            display: none;
        }
        
        /* Estilo para variables ocultas */
        .variable-item.hidden {
            opacity: 0.5;
        }
        
        /* Estilo para el botón de eliminar */
        .close-chart-btn {
            background-color: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            margin-left: 5px;
            font-size: 14px;
            padding: 2px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-chart-btn:hover {
            background-color: #e74c3c;
            color: white;
            border-radius: 3px;
        }
        
        /* Estilo para el botón de expandir/contraer */
        .expand-chart-btn {
            background-color: transparent;
            border: none;
            color: #cccccc;
            cursor: pointer;
            margin-left: 5px;
            font-size: 14px;
            padding: 2px 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .expand-chart-btn:hover {
            background-color: #2980b9;
            color: white;
            border-radius: 3px;
        }
        
        /* Estilos para gráficas expandidas */
        .chart-card.expanded {
            position: fixed;
            top: 50px;
            left: 50px;
            right: 50px;
            bottom: 50px;
            width: auto;
            height: auto;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        }
        
        .chart-card.expanded .chart-body {
            height: calc(100% - 40px);
        }
        
        /* Overlay para cuando una gráfica está expandida */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* Controles de redimensionamiento */
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #555;
            border-radius: 50%;
            z-index: 1001;
            display: none;
        }
        
        .chart-card.expanded .resize-handle {
            display: block;
        }
        
        .resize-handle.top-left {
            top: -5px;
            left: -5px;
            cursor: nw-resize;
        }
        
        .resize-handle.top-right {
            top: -5px;
            right: -5px;
            cursor: ne-resize;
        }
        
        .resize-handle.bottom-left {
            bottom: -5px;
            left: -5px;
            cursor: sw-resize;
        }
        
        .resize-handle.bottom-right {
            bottom: -5px;
            right: -5px;
            cursor: se-resize;
        }
        
        .chart-controls {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="ide-container">
        <!-- Panel de variables (izquierda) -->
        <div class="variables-panel">
            <div class="panel-header">
                Variables PLC
                <span class="status-indicator" id="connectionStatus"></span>
            </div>
            
            <div class="variable-item" id="variableDb" data-chart="db">
                <div class="variable-name">DB2.DBW0 <span class="type-float">(float)</span></div>
                <div class="variable-value" id="db1Value">--</div>
            </div>
            
            <div class="variable-item" id="variableSim1" data-chart="sim1">
                <div class="variable-name">Variable 1 <span class="type-int">(int)</span></div>
                <div class="variable-value" id="simValue1">--</div>
            </div>
            
            <div class="variable-item" id="variableSim2" data-chart="sim2">
                <div class="variable-name">Variable 2 <span class="type-int">(int)</span></div>
                <div class="variable-value" id="simValue2">--</div>
            </div>
            
            <!-- Sección de configuración -->
            <div class="panel-header" style="margin-top: 20px;">Configuración</div>
            
            <div style="padding: 15px;">
                <div style="margin-bottom: 10px;">
                    <label for="updateRateInput" style="display: block; margin-bottom: 5px; font-size: 12px;">Intervalo (ms):</label>
                    <div style="display: flex;">
                        <input type="number" id="updateRateInput" min="1" max="5000" value="100" style="width: 100px;">
                        <button id="applyRateBtn" style="margin-left: 5px;">Aplicar</button>
                    </div>
                </div>
                
                <div style="font-size: 12px; color: #888; margin-top: 20px;">
                    <div>Actualizaciones/seg: <span id="fpsCounter">0</span></div>
                    <div style="margin-top: 5px;">Tiempo respuesta: <span id="responseTime">0</span> ms</div>
                    <div style="margin-top: 15px; font-size: 11px; color: #ffcc00; display: none;" id="performanceWarning">
                        ⚠️ Atención: Intervalos muy bajos pueden afectar el rendimiento
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Panel principal (derecha) -->
        <div class="main-panel">
            <div class="toolbar">
                <h5 style="margin: 0;">Monitor PLC</h5>
                <div class="fps-counter">Actualización: <span id="updateRateDisplay">100</span> ms</div>
            </div>
            
            <!-- Contenedor principal con dos secciones: gráficas y resumen -->
            <div style="display: flex; gap: 15px; height: calc(100vh - 100px); overflow: hidden;">
                <!-- Contenedor de gráficas (ajustado para dejar espacio al resumen) -->
                <div class="charts-container" style="flex-grow: 1; grid-template-columns: 1fr; grid-auto-rows: minmax(350px, auto); overflow-y: auto; padding-right: 5px;">
                    <!-- Gráfica principal PLC -->
                    <div class="chart-card" id="chartCardDb">
                        <div class="chart-header">
                            DB2.DBW0 - Tendencia
                            <div class="chart-controls">
                                <button class="chart-control-btn" id="toggleDB" title="Reproducir/Pausar">
                                    <span class="control-icon">⏸️</span>
                                </button>
                                <button class="close-chart-btn" id="closeDB" title="Ocultar gráfica">
                                    <span>✕</span>
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="mainChartDB"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfica Variable 1 -->
                    <div class="chart-card" id="chartCardSim1">
                        <div class="chart-header">
                            Variable 1 - Tendencia
                            <div class="chart-controls">
                                <button class="chart-control-btn" id="toggleSim1" title="Reproducir/Pausar">
                                    <span class="control-icon">⏸️</span>
                                </button>
                                <button class="close-chart-btn" id="closeSim1" title="Ocultar gráfica">
                                    <span>✕</span>
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="mainChartSim1"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfica Variable 2 -->
                    <div class="chart-card" id="chartCardSim2">
                        <div class="chart-header">
                            Variable 2 - Tendencia
                            <div class="chart-controls">
                                <button class="chart-control-btn" id="toggleSim2" title="Reproducir/Pausar">
                                    <span class="control-icon">⏸️</span>
                                </button>
                                <button class="close-chart-btn" id="closeSim2" title="Ocultar gráfica">
                                    <span>✕</span>
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="mainChartSim2"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de resumen fijo a la derecha -->
                <div class="chart-card" style="width: 280px; flex-shrink: 0; max-height: calc(100vh - 100px); overflow-y: auto;">
                    <div class="chart-header" style="position: sticky; top: 0; z-index: 10;">Resumen</div>
                    <div class="chart-body" style="overflow-y: visible; height: auto;">
                        <table class="table table-sm" style="color: #d4d4d4; font-size: 12px;">
                            <thead style="position: sticky; top: 0; background-color: #252526;">
                                <tr>
                                    <th>Variable</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Promedio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="resumenDb">
                                    <td>DB2.DBW0</td>
                                    <td id="db1Min">--</td>
                                    <td id="db1Max">--</td>
                                    <td id="db1Avg">--</td>
                                </tr>
                                <tr id="resumenSim1">
                                    <td>Variable 1</td>
                                    <td id="sim1Min">--</td>
                                    <td id="sim1Max">--</td>
                                    <td id="sim1Avg">--</td>
                                </tr>
                                <tr id="resumenSim2">
                                    <td>Variable 2</td>
                                    <td id="sim2Min">--</td>
                                    <td id="sim2Max">--</td>
                                    <td id="sim2Avg">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay para cuando una gráfica está expandida -->
    <div class="overlay" id="overlay"></div>    <span class="control-icon">⏸️</span>
                                </button>
                                <button class="expand-chart-btn" id="expandDB" title="Expandir gráfica">
                                    <span>⤢</span>
                                </button>
                                <button class="close-chart-btn" id="closeDB" title="Ocultar gráfica">
                                    <span>✕</span>
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="mainChartDB"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfica Variable 1 -->
                    <div class="chart-card" id="chartCardSim1">
                        <div class="chart-header">
                            Variable 1 - Tendencia
                            <div class="chart-controls">
                                <button class="chart-control-btn" id="toggleSim1" title="Reproducir/Pausar">
                                    <span class="control-icon">⏸️</span>
                                </button>
                                <button class="expand-chart-btn" id="expandSim1" title="Expandir gráfica">
                                    <span>⤢</span>
                                </button>
                                <button class="close-chart-btn" id="closeSim1" title="Ocultar gráfica">
                                    <span>✕</span>
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="mainChartSim1"></canvas>
                        </div>
                    </div>
                    
                    <!-- Gráfica Variable 2 -->
                    <div class="chart-card" id="chartCardSim2">
                        <div class="chart-header">
                            Variable 2 - Tendencia
                            <div class="chart-controls">
                                <button class="chart-control-btn" id="toggleSim2" title="Reproducir/Pausar">
                                    <span class="control-icon">⏸️</span>
                                </button>
                                <button class="expand-chart-btn" id="expandSim2" title="Expandir gráfica">
                                    <span>⤢</span>
                                </button>
                                <button class="close-chart-btn" id="closeSim2" title="Ocultar gráfica">
                                    <span>✕</span>
                                </button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="mainChartSim2"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de resumen fijo a la derecha -->
                <div class="chart-card" style="width: 280px; flex-shrink: 0; align-self: flex-start; position: sticky; top: 15px;">
                    <div class="chart-header">Resumen</div>
                    <div class="chart-body" style="overflow-y: auto;">
                        <table class="table table-sm" style="color: #d4d4d4; font-size: 12px;">
                            <thead>
                                <tr>
                                    <th>Variable</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Promedio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="resumenDb">
                                    <td>DB2.DBW0</td>
                                    <td id="db1Min">--</td>
                                    <td id="db1Max">--</td>
                                    <td id="db1Avg">--</td>
                                </tr>
                                <tr id="resumenSim1">
                                    <td>Variable 1</td>
                                    <td id="sim1Min">--</td>
                                    <td id="sim1Max">--</td>
                                    <td id="sim1Avg">--</td>
                                </tr>
                                <tr id="resumenSim2">
                                    <td>Variable 2</td>
                                    <td id="sim2Min">--</td>
                                    <td id="sim2Max">--</td>
                                    <td id="sim2Avg">--</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Referencias a elementos del DOM
        const db1Value = document.getElementById('db1Value');
        const simValue1 = document.getElementById('simValue1');
        const simValue2 = document.getElementById('simValue2');
        const connectionStatus = document.getElementById('connectionStatus');
        const fpsCounter = document.getElementById('fpsCounter');
        const responseTime = document.getElementById('responseTime');
        const updateRateInput = document.getElementById('updateRateInput');
        const updateRateDisplay = document.getElementById('updateRateDisplay');
        const applyRateBtn = document.getElementById('applyRateBtn');
        
        // Referencias a tarjetas de gráficas
        const chartCardDb = document.getElementById('chartCardDb');
        const chartCardSim1 = document.getElementById('chartCardSim1');
        const chartCardSim2 = document.getElementById('chartCardSim2');
        
        // Referencias a variables para doble clic
        const variableDb = document.getElementById('variableDb');
        const variableSim1 = document.getElementById('variableSim1');
        const variableSim2 = document.getElementById('variableSim2');
        
        // Referencias a filas de resumen
        const resumenDb = document.getElementById('resumenDb');
        const resumenSim1 = document.getElementById('resumenSim1');
        const resumenSim2 = document.getElementById('resumenSim2');
        
        // Referencias al overlay
        const overlay = document.getElementById('overlay');
        
        // Estadísticas
        const db1Min = document.getElementById('db1Min');
        const db1Max = document.getElementById('db1Max');
        const db1Avg = document.getElementById('db1Avg');
        const sim1Min = document.getElementById('sim1Min');
        const sim1Max = document.getElementById('sim1Max');
        const sim1Avg = document.getElementById('sim1Avg');
        const sim2Min = document.getElementById('sim2Min');
        const sim2Max = document.getElementById('sim2Max');
        const sim2Avg = document.getElementById('sim2Avg');
        
        // Variables para el control de actualización
        let updateInterval = null;
        let updateRate = 100; // Default: 100ms (10 veces/segundo)
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let lastUpdateTime = 0;
        let useRequestAnimationFrame = false; // Cambiar a true para máxima velocidad
        
        // Estado de cada gráfica (true = activa, false = pausada)
        let chartStatus = {
            db: true,
            sim1: true,
            sim2: true
        };
        
        // Estado de visibilidad de las gráficas (true = visible, false = oculta)
        let chartVisibility = {
            db: true,
            sim1: true,
            sim2: true
        };
        
        // Estado de expansión de gráficas (true = expandida, false = normal)
        let expandedState = {
            db: false,
            sim1: false,
            sim2: false
        };
        
        // Datos para estadísticas
        let statsData = {
            db: { values: [], min: null, max: null, avg: null },
            sim1: { values: [], min: null, max: null, avg: null },
            sim2: { values: [], min: null, max: null, avg: null }
        };
        
        const maxDataPoints = 100; // Más puntos para las gráficas principales
        
        // Función optimizada para actualizar datos del PLC
        async function updatePlcData() {
            const startTime = performance.now();
            
            try {
                const response = await fetch('/api/status', {
                    method: 'GET',
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (!response.ok) throw new Error('Network response error');
                
                const data = await response.json();
                connectionStatus.classList.add('status-active');
                
                if (data.lastValue !== null && data.lastValue !== undefined) {
                    const plcValue = parseFloat(data.lastValue) || 0;
                    db1Value.textContent = plcValue.toFixed(2);
                    updateChartData(plcValue, 'db');
                    updateStats(plcValue, 'db');
                }
                
                // Medir tiempo de respuesta
                const endTime = performance.now();
                responseTime.textContent = Math.round(endTime - startTime);
            } catch (error) {
                console.error('Error:', error);
                connectionStatus.classList.remove('status-active');
            }
            
            // Actualiza contador de FPS
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) { // Cada segundo
                fpsCounter.textContent = frameCount;
                frameCount = 0;
                lastFpsUpdate = now;
            }
        }

        function generateRandomValue(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function simulateVariables() {
            const val1 = generateRandomValue(10, 50);
            const val2 = generateRandomValue(30, 80);
            
            simValue1.textContent = val1;
            simValue2.textContent = val2;
            
            updateChartData(val1, 'sim1');
            updateChartData(val2, 'sim2');
            
            updateStats(val1, 'sim1');
            updateStats(val2, 'sim2');
        }
        
        // Actualiza estadísticas
        function updateStats(value, key) {
            const stats = statsData[key];
            stats.values.push(value);
            
            // Limitar el número de valores para las estadísticas
            if (stats.values.length > 50) {
                stats.values.shift();
            }
            
            // Calcular estadísticas
            stats.min = Math.min(...stats.values);
            stats.max = Math.max(...stats.values);
            stats.avg = stats.values.reduce((a, b) => a + b, 0) / stats.values.length;
            
            // Actualizar en la UI
            if (key === 'db') {
                db1Min.textContent = stats.min.toFixed(2);
                db1Max.textContent = stats.max.toFixed(2);
                db1Avg.textContent = stats.avg.toFixed(2);
            } else if (key === 'sim1') {
                sim1Min.textContent = stats.min.toFixed(0);
                sim1Max.textContent = stats.max.toFixed(0);
                sim1Avg.textContent = stats.avg.toFixed(1);
            } else if (key === 'sim2') {
                sim2Min.textContent = stats.min.toFixed(0);
                sim2Max.textContent = stats.max.toFixed(0);
                sim2Avg.textContent = stats.avg.toFixed(1);
            }
        }

        // Función para actualización con RequestAnimationFrame
        function animationFrameUpdate() {
            const now = performance.now();
            const elapsed = now - lastUpdateTime;
            
            if (elapsed >= updateRate) {
                lastUpdateTime = now;
                updatePlcData();
                simulateVariables();
            }
            
            requestAnimationFrame(animationFrameUpdate);
        }

        // Función para actualización con setInterval
        function startIntervalUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            updateInterval = setInterval(() => {
                updatePlcData();
                simulateVariables();
            }, updateRate);
        }

        function startAutoRefresh() {
            if (useRequestAnimationFrame) {
                lastUpdateTime = performance.now();
                requestAnimationFrame(animationFrameUpdate);
            } else {
                startIntervalUpdate();
            }
        }

        function initializeCharts() {
            console.log("Inicializando gráficas...");
            // Crear gráficas principales
            try {
                const ctxMainDB = document.getElementById('mainChartDB').getContext('2d');
                window.mainChartDB = createMainChart(ctxMainDB, 'blue', 'DB2.DBW0');
                console.log("Gráfica DB creada:", window.mainChartDB);
                
                const ctxMainSim1 = document.getElementById('mainChartSim1').getContext('2d');
                window.mainChartSim1 = createMainChart(ctxMainSim1, 'green', 'Variable 1');
                console.log("Gráfica Sim1 creada:", window.mainChartSim1);
                
                const ctxMainSim2 = document.getElementById('mainChartSim2').getContext('2d');
                window.mainChartSim2 = createMainChart(ctxMainSim2, 'red', 'Variable 2');
                console.log("Gráfica Sim2 creada:", window.mainChartSim2);
            } catch (error) {
                console.error("Error al inicializar gráficas:", error);
            }
        }

        function createMainChart(ctx, color, label) {
            // Generar etiquetas de tiempo para el eje X
            const labels = Array(maxDataPoints).fill('').map((_, i) => {
                return `-${(maxDataPoints - i) * (updateRate / 1000)}s`;
            });
            
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: label,
                        data: Array(maxDataPoints).fill(null), 
                        borderColor: color, 
                        backgroundColor: color + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false, // Desactivar animaciones para mejor rendimiento
                    scales: { 
                        x: { 
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#888888',
                                maxRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: 6
                            }
                        }, 
                        y: { 
                            grid: {
                                color: '#333333'
                            },
                            ticks: {
                                color: '#888888'
                            }
                        } 
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateChartData(value, key) {
            // Solo actualizar si la gráfica no está pausada y está visible
            if (!chartStatus[key] || !chartVisibility[key]) return;
            
            let chart = null;
            if (key === 'db') chart = window.mainChartDB;
            if (key === 'sim1') chart = window.mainChartSim1;
            if (key === 'sim2') chart = window.mainChartSim2;

            if (chart) {
                // Actualizar datos de forma eficiente
                const data = chart.data.datasets[0].data;
                data.push(value);
                data.shift();
                chart.update('none'); // Modo 'none' para máximo rendimiento
            }
        }

        // Event listener para cambiar tasa de actualización
        applyRateBtn.addEventListener('click', () => {
            const newRate = parseInt(updateRateInput.value);
            if (!isNaN(newRate) && newRate >= 1 && newRate <= 5000) {
                updateRate = newRate;
                updateRateDisplay.textContent = newRate;
                
                // Cambiar automáticamente a RequestAnimationFrame para tasas muy rápidas
                if (newRate < 16) { // 16ms es aproximadamente 60fps
                    useRequestAnimationFrame = true;
                    if (updateInterval) {
                        clearInterval(updateInterval);
                        updateInterval = null;
                    }
                    // Iniciar animación si no está corriendo
                    if (lastUpdateTime === 0) {
                        lastUpdateTime = performance.now();
                        requestAnimationFrame(animationFrameUpdate);
                    }
                    console.log("Modo ultra-rápido activado usando requestAnimationFrame");
                } else {
                    // Volver a setInterval para tasas más lentas
                    useRequestAnimationFrame = false;
                    startIntervalUpdate();
                }
                
                // Actualizar etiquetas de tiempo en los gráficos
                [window.mainChartDB, window.mainChartSim1, window.mainChartSim2].forEach(chart => {
                    if (chart) {
                        chart.data.labels = Array(maxDataPoints).fill('').map((_, i) => {
                            return `-${((maxDataPoints - i) * (updateRate / 1000)).toFixed(1)}s`;
                        });
                    }
                });
                
                // Agregar advertencia para valores muy bajos
                const warningElement = document.getElementById('performanceWarning');
                if (newRate < 10) {
                    warningElement.style.display = 'block';
                    console.warn("¡Atención! Intervalos muy bajos pueden sobrecargar el navegador y el PLC.");
                } else {
                    warningElement.style.display = 'none';
                }
            }
        });

        // Función para alternar estado de reproducción/pausa
        function toggleChartStatus(key) {
            const status = chartStatus[key];
            chartStatus[key] = !status;
            
            // Actualizar el botón
            let buttonId, iconElement;
            if (key === 'db') {
                buttonId = 'toggleDB';
            } else if (key === 'sim1') {
                buttonId = 'toggleSim1';
            } else if (key === 'sim2') {
                buttonId = 'toggleSim2';
            }
            
            if (buttonId) {
                const button = document.getElementById(buttonId);
                const iconElement = button.querySelector('.control-icon');
                
                if (chartStatus[key]) {
                    // Reproduciendo (muestro pausa)
                    iconElement.textContent = '⏸️';
                    button.title = 'Pausar';
                } else {
                    // Pausado (muestro play)
                    iconElement.textContent = '▶️';
                    button.title = 'Reproducir';
                }
            }
        }
        
        // Función para ocultar o mostrar una gráfica
        function toggleChartVisibility(key) {
            chartVisibility[key] = !chartVisibility[key];
            
            let chartCard, variableItem, resumenRow;
            if (key === 'db') {
                chartCard = chartCardDb;
                variableItem = variableDb;
                resumenRow = resumenDb;
            } else if (key === 'sim1') {
                chartCard = chartCardSim1;
                variableItem = variableSim1;
                resumenRow = resumenSim1;
            } else if (key === 'sim2') {
                chartCard = chartCardSim2;
                variableItem = variableSim2;
                resumenRow = resumenSim2;
            }
            
            if (chartCard && variableItem && resumenRow) {
                if (chartVisibility[key]) {
                    // Mostrar la gráfica y su información
                    chartCard.classList.remove('hidden');
                    variableItem.classList.remove('hidden');
                    resumenRow.style.display = ''; // Mostrar en tabla de resumen
                } else {
                    // Ocultar la gráfica y su información
                    chartCard.classList.add('hidden');
                    variableItem.classList.add('hidden');
                    resumenRow.style.display = 'none'; // Ocultar de tabla de resumen
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            startAutoRefresh();
            
            // Añadir event listeners para los botones de play/pausa
            document.getElementById('toggleDB').addEventListener('click', function() {
                toggleChartStatus('db');
            });
            
            document.getElementById('toggleSim1').addEventListener('click', function() {
                toggleChartStatus('sim1');
            });
            
            document.getElementById('toggleSim2').addEventListener('click', function() {
                toggleChartStatus('sim2');
            });
            
            // Añadir event listeners para los botones de cerrar
            document.getElementById('closeDB').addEventListener('click', function() {
                toggleChartVisibility('db');
            });
            
            document.getElementById('closeSim1').addEventListener('click', function() {
                toggleChartVisibility('sim1');
            });
            
            document.getElementById('closeSim2').addEventListener('click', function() {
                toggleChartVisibility('sim2');
            });
            
            // Añadir event listeners para doble clic en las variables
            variableDb.addEventListener('dblclick', function() {
                if (!chartVisibility['db']) toggleChartVisibility('db');
            });
            
            variableSim1.addEventListener('dblclick', function() {
                if (!chartVisibility['sim1']) toggleChartVisibility('sim1');
            });
            
            variableSim2.addEventListener('dblclick', function() {
                if (!chartVisibility['sim2']) toggleChartVisibility('sim2');
            });
        });
    </script>
</body>
</html>